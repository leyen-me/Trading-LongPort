//@version=6
indicator("StarTrack", overlay = true)

// =============================================================================
// å…¨å±€å›ºå®š
// =============================================================================
RSI_LENGTH = 14
MIN_PEAK_STRENGTH = 2
BB_LENGTH = 20
BB_MULTIPLIER = 2

// =============================================================================
// å…¬å…±å‡½æ•°
// =============================================================================

ma(source, length, _type) =>
    switch _type
        "SMA" => ta.sma(source, length)
        "EMA" => ta.ema(source, length)
        "SMMA (RMA)" => ta.rma(source, length)
        "WMA" => ta.wma(source, length)
        "VWMA" => ta.vwma(source, length)

// =============================================================================
// å…¨å±€å˜é‡
// =============================================================================

green_color = color.new(#089981, 0)
red_color = color.new(#F23645, 0)

transparent_color_upper = color.new(#F23645, 70)  // çº¢è‰²ï¼Œ70% é€æ˜
transparent_color_lower = color.new(#089981, 70)  // ç»¿è‰²ï¼Œ70% é€æ˜
transparent_color_basis = color.new(#2962FF, 70)  // è“è‰²ï¼Œ70% é€æ˜
transparent_color_gap   = color.new(#2196F3, 95)  // è“è‰²ï¼Œ95% é€æ˜

// =============================================================================
// æŒ‡æ ‡è®¾ç½® (Indicator Settings)
// =============================================================================

// å¸ƒæ—çº¿æŒ‡æ ‡è®¾ç½®
rsi_group            = "RSI è®¾ç½®"
rsi_oversold = input.int(30, title="è¶…å–æ°´å¹³", minval=0, maxval=100, group=rsi_group)
rsi_overbought = input.int(70, title="è¶…ä¹°æ°´å¹³", minval=0, maxval=100, group=rsi_group)

bb_group            = "å¸ƒæ—å¸¦å‚æ•°"
bb_ma_type          = input.string("SMA", "ç§»åŠ¨å¹³å‡çº¿ç±»å‹", options = ["SMA", "EMA", "SMMA (RMA)", "WMA", "VWMA"], group=bb_group)
bb_length           = input.int(20, "å¸ƒæ—å¸¦å‘¨æœŸ", minval=1, group=bb_group)
bb_mult             = input.float(2.0, "æ ‡å‡†å·®ä¹˜æ•°", minval=0.001, maxval=50, group=bb_group)

group_st           = "è¶…çº§è¶‹åŠ¿ï¼ˆSuperTrendï¼‰"
input_atrPeriod    = input.int(10, "ATRå‘¨æœŸ", minval = 1, group=group_st)
input_factor       = input.float(2.1, "æ”¾å¤§ç³»æ•°", minval = 0.01, step = 0.01, group=group_st)

// å†·å´å‚æ•°
cooldown_bars = input.int(10, "ä¿¡å·å†·å´å‘¨æœŸï¼ˆæ ¹Kçº¿ï¼‰", minval=1, maxval=50, group="é£é™©ç®¡ç†")

// =============================================================================
// è®¡ç®—éƒ¨åˆ† (Calculation Logic)
// =============================================================================

// å¸ƒæ—çº¿è®¡ç®—
bb_basis = ma(close, bb_length, bb_ma_type)
bb_dev   = bb_mult * ta.stdev(close, bb_length)
bb_upper = bb_basis + bb_dev
bb_lower = bb_basis - bb_dev

bb_price_touch_lower = low <= bb_lower  // ä»·æ ¼è§¦åŠä¸‹è½¨
bb_price_below_lower = close > bb_lower  // æ”¶ç›˜ä»·çªç ´ä¸‹è½¨ï¼ˆä¸‹è·Œè¶‹åŠ¿å‡å¼±ï¼‰

bb_price_touch_upper = high >= bb_upper  // ä»·æ ¼è§¦åŠä¸Šè½¨
bb_price_below_upper = close < bb_upper  // æ”¶ç›˜ä»·è·Œç ´ä¸Šè½¨ï¼ˆä¸Šæ¶¨è¶‹åŠ¿å‡å¼±ï¼‰
bb_price_cross_mid_up = ta.crossover(close, bb_basis)  // å›è¸©ä¸­è½¨åå›å‡
bb_price_cross_mid_down = ta.crossunder(close, bb_basis)  // è·Œç ´ä¸­è½¨

bb_buy_signal = bb_price_touch_lower and bb_price_below_lower
bb_sell_signal = bb_price_touch_upper and bb_price_below_upper

// SuperTrend è®¡ç®—
[st_val, dir]     = ta.supertrend(input_factor, input_atrPeriod)
supertrend        = barstate.isfirst ? na : st_val

// =============================================================================
// RSI è®¡ç®—éƒ¨åˆ†
// =============================================================================
// è®¡ç®— RSI å€¼
rsi0 = ta.rsi(close, RSI_LENGTH)
rsi1 = ta.change(rsi0, 1)
rsi2 = ta.change(rsi0, 2)

rsi_is_peak = ta.falling(rsi0, MIN_PEAK_STRENGTH) and rsi0 >= rsi_overbought  // æ£€æµ‹è¶…ä¹°åŒºåŸŸçš„å³°å€¼
rsi_is_dip = ta.rising(rsi0, MIN_PEAK_STRENGTH) and rsi0 <= rsi_oversold      // æ£€æµ‹è¶…å–åŒºåŸŸçš„è°·å€¼
rsi_cross_oversold = ta.crossover(rsi0, rsi_oversold)      // RSI å‘ä¸Šç©¿è¶Šè¶…å–çº¿
rsi_cross_under_bought = ta.crossunder(rsi0, rsi_overbought) // RSI å‘ä¸‹ç©¿è¶Šè¶…ä¹°çº¿

rsi_buy_signal = (rsi_is_dip and rsi1 > 0 and rsi2 > 0) or rsi_cross_oversold
rsi_sell_signal = (rsi_is_peak and rsi1 < 0 and rsi2 < 0) or rsi_cross_under_bought

// =============================================================================
// å¤åˆä¿¡å·ï¼ˆåŸé€»è¾‘ï¼‰
// =============================================================================

max_gap = 2
bb_bought_recently = ta.barssince(bb_buy_signal) <= max_gap
rsi_bought_recently = ta.barssince(rsi_buy_signal) <= max_gap
buy_signal_raw = bb_bought_recently and rsi_bought_recently and (bb_buy_signal or rsi_buy_signal)

bb_sold_recently = ta.barssince(bb_sell_signal) <= max_gap
rsi_sold_recently = ta.barssince(rsi_sell_signal) <= max_gap
sell_signal_raw = bb_sold_recently and rsi_sold_recently and (bb_sell_signal or rsi_sell_signal)

// =============================================================================
// ğŸ”¥ å†·å´æœºåˆ¶ + çŠ¶æ€ç®¡ç†
// =============================================================================

var int last_buy_trade_bar = na
var int last_sell_trade_bar = na

// åˆ¤æ–­æ˜¯å¦å¤„äºå†·å´æœŸ
is_buy_cooldown() =>
    not na(last_buy_trade_bar) and (bar_index - last_buy_trade_bar) < cooldown_bars

is_sell_cooldown() =>
    not na(last_sell_trade_bar) and (bar_index - last_sell_trade_bar) < cooldown_bars

can_enter_long = buy_signal_raw and not is_buy_cooldown()
should_exit_long = sell_signal_raw and not is_sell_cooldown()

// =============================================================================
// äº¤æ˜“
// =============================================================================

if can_enter_long
    last_buy_trade_bar := bar_index
    alert('{ "ticker": "{{ticker}}", "action": "buy", "sentiment": "long", "price": "{{close}}", "desc":"ğŸš€ ä¹°å…¥è­¦æŠ¥è§¦å‘ï¼" }', alert.freq_once_per_bar)

if should_exit_long
    last_sell_trade_bar := bar_index
    alert('{ "ticker": "{{ticker}}", "action": "buy", "sentiment": "flat", "price": "{{close}}", "desc":"â˜„ï¸ å–å‡ºè­¦æŠ¥è§¦å‘ï¼" }', alert.freq_once_per_bar)

// =============================================================================
// ç»˜åˆ¶
// =============================================================================

// å¸ƒæ—å¸¦ç»˜åˆ¶
bb_basis_p = plot(bb_basis, "å¸ƒæ—çº¿", color=transparent_color_basis, linewidth=1) // ä¸­è½¨
bb_upper_p = plot(bb_upper, "å¸ƒæ—çº¿ä¸Šè½¨", color=transparent_color_upper, linewidth=1) // ä¸Šè½¨
bb_lower_p = plot(bb_lower, "å¸ƒæ—çº¿ä¸‹è½¨", color=transparent_color_lower, linewidth=1) // ä¸‹è½¨
fill(bb_upper_p, bb_lower_p, title = "å¸ƒæ—å¸¦", color=transparent_color_gap)  // ä¸¤ä¸ªè½¨é“ä¹‹é—´

// supertrend
upTrend =    plot(dir < 0 ? supertrend : na, "Up Trend",   color = color.green, style = plot.style_linebr)
downTrend =  plot(dir < 0 ? na : supertrend, "Down Trend", color = color.red,   style = plot.style_linebr)
bodyMiddle = plot(barstate.isfirst ? na : (open + close) / 2, "Body Middle",display = display.none)
fill(bodyMiddle, upTrend,   title = "Uptrend background",   color = color.new(color.green, 90), fillgaps = false)
fill(bodyMiddle, downTrend, title = "Downtrend background", color = color.new(color.red,   90), fillgaps = false)

plotshape(can_enter_long, title='å®é™…ä¹°å…¥', style=shape.triangleup,   location=location.belowbar, color=color.new(green_color,  0), size=size.tiny)
plotshape(should_exit_long, title='å®é™…å–å‡º', style=shape.triangledown, location=location.abovebar, color=color.new(red_color, 0), size=size.tiny)

plotshape(buy_signal_raw, title='ä¹°å…¥', style=shape.triangleup,   location=location.belowbar, color=color.new(green_color,  50), size=size.tiny)
plotshape(sell_signal_raw, title='å–å‡º', style=shape.triangledown, location=location.abovebar, color=color.new(red_color, 50), size=size.tiny)