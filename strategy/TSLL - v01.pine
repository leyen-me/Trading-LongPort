//@version=6
strategy(title = "ã€ç ´æ™“è€… ProÂ·åœ°ç‹±åˆ¶è£ç‰ˆã€‘âš¡TSLL ONLY", overlay = true, 
         default_qty_type = strategy.percent_of_equity, default_qty_value = 50, 
         commission_type = strategy.commission.percent, commission_value = 0.01,
         calc_on_every_tick = false, process_orders_on_close = true, pyramiding = 1)

// =============================================================================
// ğŸ§¨ æ ¸å¿ƒå‚æ•°ï¼šè€å­çš„åˆ€ï¼Œåªç é¾™å¤´
// =============================================================================

int     OPEN_MINUTES     = input.int(30, "ğŸ”¥ å¼€ç›˜åŠ¨èƒ½çª—å£", minval=15, maxval=60)
float   VOL_MULT         = input.float(2, "ğŸ’¥ è„‰å†²æ”¾é‡é˜ˆå€¼", minval=1.5, step=0.1, maxval=4.0)
int     ATR_LEN          = input.int(14, "ğŸŒ€ ATRå‘¨æœŸ", minval=5)
float   ATR_SL_MULT      = input.float(5.7, "ğŸ’€ æ­¢æŸå€æ•°", minval=0.5, step=0.1)
float   ATR_TP_MULT      = input.float(6.8, "ğŸ¯ æ­¢ç›ˆå€æ•°", minval=0.5, step=0.1)

bool    USE_VOL_SPIKE    = input.bool(true, "âš¡ å¯ç”¨æˆäº¤é‡è„‰å†²è¿‡æ»¤")
bool    DEBUG_MODE       = input.bool(false, "ğŸ è°ƒè¯•æ¨¡å¼ï¼ˆæ˜¾ç¤ºå†…éƒ¨å˜é‡ï¼‰")

// =============================================================================
// ğŸŒ† ç¾ä¸œæ—¶é—´ï¼šåªåœ¨æˆ˜åœºå¼€é—¨æ—¶åŠ¨æ‰‹
// =============================================================================

bool is_trading_day = not na(time("D", "America/New_York"))
bool is_market_open = not na(time("1", "0930-1600", "America/New_York"))
bool is_signal_zone = not na(time("1", "0930-1130", "America/New_York"))
bool is_close_zone  = not na(time("1", "1545-1600", "America/New_York"))

// =============================================================================
// ğŸ§± åŠ¨æ€å¼€ç›˜åŒºé—´ï¼šä¸æ˜¯é™æ€é«˜ä½ï¼Œæ˜¯â€œæ´»â€çš„ï¼
//     ä½¿ç”¨ VWAP Â± 1.5Ïƒ ä½œä¸ºåŠ¨æ€æ”¯æ’‘/å‹åŠ›ï¼Œæ¯”ä½ é‚£max/miné«˜çº§ä¸€ä¸‡å€
// =============================================================================

// =============================================================================
// ğŸ›  ä¿®å¤ç‰ˆ v3.0ï¼šå‘½åè§„èŒƒï¼Œé€»è¾‘é—­ç¯ï¼Œäººå†™äººçˆ±
// =============================================================================

var float cum_vol_price = 0.0  // Î£(volume * close)
var float cum_vol       = 0.0  // Î£(volume)
var float cum_vol_sq    = 0.0  // Î£(volume * closeÂ²)
var int   bar_count     = 0

bool is_open_session = not na(time("1", "0930-1000", "America/New_York"))
bool is_new_day = ta.change(time("D")) != 0

// é‡ç½®æ–°äº¤æ˜“æ—¥
if is_new_day
    cum_vol_price := volume * close
    cum_vol       := volume
    cum_vol_sq    := volume * math.pow(close, 2)
    bar_count     := 1
else if is_open_session
    cum_vol_price := cum_vol_price + volume * close
    cum_vol       := cum_vol + volume
    cum_vol_sq    := cum_vol_sq + volume * math.pow(close, 2)
    bar_count     := bar_count + 1

// âœ… è®¡ç®— VWAP
float vwap = cum_vol_price / cum_vol

// âœ… è®¡ç®—æ–¹å·®ï¼ˆç”¨ varianceï¼Œä¸æ˜¯ varï¼ï¼‰
float vwap_variance = (cum_vol_sq / cum_vol) - math.pow(vwap, 2)
float vwap_std_dev = math.sqrt(vwap_variance)

// âœ… åŠ¨æ€é«˜ä½ç‚¹
float dynamic_high = vwap + 1.5 * vwap_std_dev
float dynamic_low  = vwap - 1.5 * vwap_std_dev

// âœ… é”å®šå¼€ç›˜åŒºé—´ï¼ˆä»…åœ¨å¼€ç›˜ä¼šè¯ç»“æŸåï¼‰
var float locked_high = na
var float locked_low  = na

if is_new_day
    locked_high := na
    locked_low  := na
else if not is_open_session and na(locked_high)
    locked_high := dynamic_high
    locked_low  := dynamic_low

// æœ€ç»ˆä½¿ç”¨é”å®šå€¼
float entry_high = locked_high
float entry_low  = locked_low

// =============================================================================
// ğŸ©¸ æˆäº¤é‡è„‰å†²æ£€æµ‹ï¼šä¸æ˜¯SMAï¼Œæ˜¯â€œå¿ƒè·³éª¤åœå¼â€çˆ†å‘
//     ä½¿ç”¨EMA + Z-Scoreè¯†åˆ«å¼‚å¸¸æ”¾é‡
// =============================================================================

float ema_vol = ta.ema(volume, 20)
float zscore = (volume - ema_vol) / ta.stdev(volume, 20)

bool is_volume_spike_up = zscore > 2.0 and volume > ema_vol * VOL_MULT
bool is_volume_spike_dn = zscore > 2.0 and volume > ema_vol * VOL_MULT

// =============================================================================
// âœ… ä¿¡å·ç”Ÿæˆï¼šç²¾å‡†æ‰“å‡»ï¼Œä¸æ‰“é©¬åç‚®
// =============================================================================

bool no_position = strategy.position_size == 0

bool long_setup = high >= entry_high and is_volume_spike_up and no_position and is_signal_zone
bool short_setup = low <= entry_low and is_volume_spike_dn and no_position and is_signal_zone

// é˜²é‡å¤å¼€ä»“
var bool long_triggered = false
var bool short_triggered = false

if is_new_day
    long_triggered  := false
    short_triggered := false

bool long_signal  = long_setup and not long_triggered
bool short_signal = short_setup and not short_triggered

// =============================================================================
// ğŸ›¡ï¸ åŠ¨æ€ATRæ­¢æŸï¼šä¼šâ€œè·‘â€çš„æ­¢æŸæ‰å«æ­¢æŸ
//     ä½¿ç”¨ATR + æ–œç‡è‡ªé€‚åº”ï¼Œé¿å…è¢«éœ‡è¡æ´—å‡º
// =============================================================================

// è®¡ç®— ATR
atrValue = ta.atr(ATR_LEN)

// åˆå§‹åŒ–æ­¢æŸå’Œæ­¢ç›ˆ
var float stopLossLong = na
var float takeProfitLong = na
var float trailStopLong = na

var float stopLossShort = na
var float takeProfitShort = na
var float trailStopShort = na

if (long_signal)
    strategy.entry("Long", strategy.long)
    stopLossLong := close - ATR_SL_MULT * atrValue  // åˆå§‹æ­¢æŸä¸ºå½“å‰ä»·æ ¼å‡å»ATRå€æ•°
    takeProfitLong := close + ATR_TP_MULT * atrValue  // åˆå§‹æ­¢ç›ˆä¸ºå½“å‰ä»·æ ¼åŠ ä¸ŠATRå€æ•°
    trailStopLong := close - ATR_SL_MULT * atrValue  // åˆå§‹è¿½è¸ªæ­¢æŸä¸ºå½“å‰ä»·æ ¼å‡å»ATRå€æ•°
    long_triggered := true

if (short_signal)
    strategy.entry("Short", strategy.short)
    short_triggered := true
    stopLossShort := close + ATR_SL_MULT * atrValue  // åˆå§‹æ­¢æŸä¸ºå½“å‰ä»·æ ¼åŠ ä¸ŠATRå€æ•°
    takeProfitShort := close - ATR_TP_MULT * atrValue  // åˆå§‹æ­¢ç›ˆä¸ºå½“å‰ä»·æ ¼å‡å»ATRå€æ•°
    trailStopShort := close + ATR_SL_MULT * atrValue  // åˆå§‹è¿½è¸ªæ­¢æŸä¸ºå½“å‰ä»·æ ¼åŠ ä¸ŠATRå€æ•°

// è¿½è¸ªæ­¢æŸï¼ˆåšå¤šï¼‰
if strategy.position_size > 0

    // åŠ¨æ€è¿½è¸ªæ­¢æŸï¼šå‘ä¸Šç§»åŠ¨è¿½è¸ªæ­¢æŸ
    if (close > trailStopLong)
        trailStopLong := math.max(trailStopLong, close - ATR_SL_MULT * atrValue)  // æ›´æ–°è¿½è¸ªæ­¢æŸ

    // å¦‚æœä»·æ ¼è§¦åŠæ­¢æŸæˆ–æ­¢ç›ˆï¼Œåˆ™å¹³ä»“
    if (close <= stopLossLong or close >= takeProfitLong or close <= trailStopLong)
        strategy.close("Long")
        long_triggered := false

// è¿½è¸ªæ­¢æŸï¼ˆåšç©ºï¼‰
if strategy.position_size < 0
    // åŠ¨æ€è¿½è¸ªæ­¢æŸï¼šå‘ä¸‹ç§»åŠ¨è¿½è¸ªæ­¢æŸ
    if (close < trailStopShort)
        trailStopShort := math.min(trailStopShort, close + ATR_SL_MULT * atrValue)  // æ›´æ–°è¿½è¸ªæ­¢æŸ

    // å¦‚æœä»·æ ¼è§¦åŠæ­¢æŸæˆ–æ­¢ç›ˆï¼Œåˆ™å¹³ä»“
    if (close >= stopLossShort or close <= takeProfitShort or close >= trailStopShort)
        strategy.close("Short")
        short_triggered := false

// æ”¶ç›˜æ¸…ä»“ï¼šç»ä¸ç•™è¿‡å¤œï¼Œç›˜åéƒ½æ˜¯é™·é˜±
if is_close_zone
    strategy.close_all(comment="ã€æ”¶ç›˜æ¸…ä»“Â·é˜²è¯ˆã€‘")
    long_triggered := false
    short_triggered := false

// =============================================================================
// ğŸ¨ å¯è§†åŒ–ï¼šè®©ä½ çœ‹å¾—æ¸…ï¼Œæ­»å¾—æ˜
// =============================================================================

// åŠ¨æ€åŒºé—´
plot(entry_high, "ğŸ”¥ åŠ¨æ€çªç ´é«˜", color=color.orange, linewidth=2, style=plot.style_linebr)
plot(entry_low,  "ğŸ”» åŠ¨æ€çªç ´ä½", color=color.teal,    linewidth=2, style=plot.style_linebr)

// ä¿¡å·æ ‡è®°
plotshape(long_signal, "ğŸ“ˆ åœ°ç‹±å¤š", location=location.belowbar, color=color.red, style=shape.labelup, text="ğŸ”¥å¤š", size=size.normal)
plotshape(short_signal, "ğŸ“‰ åœ°ç‹±ç©º", location=location.abovebar, color=color.lime, style=shape.labeldown, text="ğŸ”»ç©º", size=size.normal)

// èƒŒæ™¯ï¼šä¿¡å·çª—å£
bgcolor(is_signal_zone ? color.new(color.red, 90) : na, title="ã€åœ°ç‹±å¼€é—¸ã€‘")

// è°ƒè¯•ä¿¡æ¯
if DEBUG_MODE
    label.new(bar_index, high, text=str.tostring(zscore, "#.##") + "\n" + str.tostring(volume / ema_vol, "#.##x"), color=color.yellow, textcolor=color.black, style=label.style_label_down)