//@version=5
//@strategy_author Leyen
//@description 
//@description VWAP ç­–ç•¥ v2
//@description 
//@description åŸºäºŽé«˜çº§åˆ«æ—¶é—´å‘¨æœŸï¼ˆå¦‚å‘¨çº¿ï¼‰çš„ VWAP ä½œä¸ºåŠ¨æ€æ”¯æ’‘/é˜»åŠ›ä½è¿›è¡Œäº¤æ˜“ã€‚
//@description å½“ä»·æ ¼ä¸Šç©¿æˆ–ä¸‹ç©¿ VWAP æ—¶è§¦å‘å¤šç©ºä¿¡å·ï¼Œç»“åˆ ATR è®¾ç½®æ­¢ç›ˆæ­¢æŸä¸Žç§»åŠ¨æ­¢æŸã€‚
//@description 
//@description ðŸ” ç‰ˆæœ¬æ›´æ–°æ—¥å¿—ï¼š
//@description 
//@description v2 (2025-08-13)ï¼š
//@description   â€¢ ã€æ ¸å¿ƒä¼˜åŒ–ã€‘å°† new_session åˆ¤æ–­ä»Ž request.security æ”¹ä¸º time(tf_vwap)
//@description     - é˜²æ­¢é‡ç»˜ï¼šæ—§æ–¹æ³•åœ¨è·¨å‘¨æœŸè¯·æ±‚ time æ—¶å¯èƒ½å¯¼è‡´åŽ†å²ä¿¡å·è·³å˜
//@description     - æ›´ç¨³å®šï¼šé¿å… security è°ƒç”¨å¸¦æ¥çš„å¼‚æ­¥/å»¶è¿Ÿ/æ˜ å°„é—®é¢˜
//@description     - æ›´é«˜æ•ˆï¼šæ— éœ€è·¨å“ç§è¯·æ±‚ï¼Œé™ä½Žèµ„æºæ¶ˆè€—
//@description     - æŽ¨èåšæ³•ï¼šç¬¦åˆ Pine Script v5 å¤šæ—¶é—´æ¡†æž¶æœ€ä½³å®žè·µ
//@description   â€¢ ç‰¹åˆ«é€‚ç”¨äºŽå®žç›˜äº¤æ˜“ä¸Žå›žæµ‹ä¸€è‡´æ€§è¦æ±‚é«˜çš„åœºæ™¯
//@description 
//@description ðŸ›  ç­–ç•¥ç‰¹æ€§ï¼š
//@description   â€¢ æ”¯æŒè‡ªå®šä¹‰é«˜çº§åˆ« VWAP å‘¨æœŸï¼ˆé»˜è®¤ï¼šå‘¨çº¿ï¼‰
//@description   â€¢ æ”¯æŒå¤šå•ä¸Žç©ºå•å¼€å…³æŽ§åˆ¶
//@description   â€¢ åŸºäºŽ ATR çš„æ­¢ç›ˆã€æ­¢æŸä¸Žç§»åŠ¨æ­¢æŸæœºåˆ¶
//@description   â€¢ å¯è§†åŒ– VWAP çº¿ã€ä¿¡å·æ ‡è®°ä¸Ž K çº¿ç€è‰²
//@description 
//@description ðŸ“Š ä½¿ç”¨å»ºè®®ï¼š
//@description   â€¢ æŽ¨èæ—¶é—´å‘¨æœŸï¼š4å°æ—¶åŠä»¥ä¸Š
//@description   â€¢ é€‚ç”¨å¸‚åœºï¼šé«˜æ³¢åŠ¨èµ„äº§ï¼ˆå¦‚ TLSAã€Meme å¸ç­‰ï¼‰
//@description   â€¢ é£Žé™©æç¤ºï¼šATR å€æ•°è®¾ç½®è¿‡é«˜æˆ–è¿‡ä½Žå¯èƒ½å½±å“ç›ˆäºæ¯”ï¼Œè¯·æ ¹æ®å“ç§æ³¢åŠ¨æ€§è°ƒæ•´
//@description 
//@description ðŸ’¬ è”ç³»æ–¹å¼ï¼š6772228275@qq.com
//@link https://github.com/leyen-me/VWAP


strategy("vwap-v3",
     overlay = true,
     initial_capital = 10000,
     default_qty_type = strategy.percent_of_equity,
     default_qty_value = 100,
     commission_type = strategy.commission.percent,
     commission_value = 0.1,
     pyramiding=1,
     calc_on_every_tick = true)


// =======================
// è¾“å…¥å‚æ•°
// =======================

// é«˜çº§åˆ« VWAP è®¡ç®—å‘¨æœŸ
tf_vwap = input.timeframe("W", "VWAP é«˜çº§åˆ«å‘¨æœŸ")

// æ­¢ç›ˆæ­¢æŸï¼ˆåŸºäºŽ ATRï¼‰
trail_mult = input.float(2, "ç§»åŠ¨æ­¢æŸå€æ•° (ATR)", minval=0.1)
atr_len   = input.int(14, "ATR é•¿åº¦")

// =======================
// å¤šæ—¶é—´æ¡†æž¶ VWAP è®¡ç®—
// =======================

// è®°å½•é«˜çº§åˆ«å‘¨æœŸçš„èµ·ç‚¹æ—¶é—´
session_start = request.security(syminfo.tickerid, tf_vwap, time)
new_session   = ta.change(session_start) != 0

// ç´¯ç§¯è®¡ç®— VWAP
var float sum_pv   = na  // price * volume ç´¯ç§¯
var float sum_vol  = na  // volume ç´¯ç§¯
var float sum_p2v  = na  // price^2 * volume ç´¯ç§¯ï¼ˆå¯æ‰©å±•ï¼‰

if new_session
    sum_pv  := hl2 * volume
    sum_vol := volume
    sum_p2v := hl2 * hl2 * volume
else
    sum_pv  += hl2 * volume
    sum_vol += volume
    sum_p2v += hl2 * hl2 * volume

// å½“å‰ VWAP
vwap = sum_vol > 0 ? sum_pv / sum_vol : na

// ä¸Šå‘¨æœŸ VWAPï¼ˆä»…åœ¨æ–°å‘¨æœŸè®°å½•ï¼‰
var float prev_vwap = na
if new_session
    prev_vwap := vwap[1]


// =======================
// äº¤æ˜“ä¿¡å· & æ­¢ç›ˆæ­¢æŸè®¡ç®—
// =======================

// ATR è®¡ç®—
atr_val = ta.atr(atr_len)

// ä¿¡å·æ¡ä»¶
long_signal  = ta.crossover(close, vwap)   and not new_session
short_signal = ta.crossunder(close, vwap)  and not new_session

// =======================
// äº¤æ˜“æ‰§è¡Œï¼ˆæ‰‹åŠ¨æ­¢ç›ˆæ­¢æŸç‰ˆï¼‰
// =======================

// è®°å½•æ­¢æŸå˜é‡
var float long_stop  = na
var float short_stop = na

if long_signal
    strategy.entry("Long", strategy.long)
    // åˆå§‹æ­¢æŸï¼ˆå¼€ä»“ä»· - ATRå€æ•°ï¼‰
    long_stop := close - atr_val * trail_mult

if short_signal
    strategy.entry("Short", strategy.short)
    // åˆå§‹æ­¢æŸï¼ˆå¼€ä»“ä»· + ATRå€æ•°ï¼‰
    short_stop := close + atr_val * trail_mult

// å¤šå•æŒä»“æ—¶ï¼Œæ›´æ–°ç§»åŠ¨æ­¢æŸ
if strategy.position_size > 0
    long_stop := math.max(long_stop, close - atr_val * trail_mult)
    if close < long_stop
        strategy.close("Long", comment="Long Stop Hit")

// ç©ºå•æŒä»“æ—¶ï¼Œæ›´æ–°ç§»åŠ¨æ­¢æŸ
if strategy.position_size < 0
    short_stop := math.min(short_stop, close + atr_val * trail_mult)
    if close > short_stop
        strategy.close("Short", comment="Short Stop Hit")

// =======================
// ç»˜å›¾
// =======================
plot(vwap, "VWAP",  color = close > vwap ? color.green : color.red, linewidth = 1, style = plot.style_linebr)