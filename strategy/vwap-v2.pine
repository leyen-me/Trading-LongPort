//@version=5
//@strategy_author Leyen
//@description 
//@description VWAP ç­–ç•¥ v2
//@description 
//@description åŸºäºé«˜çº§åˆ«æ—¶é—´å‘¨æœŸï¼ˆå¦‚å‘¨çº¿ï¼‰çš„ VWAP ä½œä¸ºåŠ¨æ€æ”¯æ’‘/é˜»åŠ›ä½è¿›è¡Œäº¤æ˜“ã€‚
//@description å½“ä»·æ ¼ä¸Šç©¿æˆ–ä¸‹ç©¿ VWAP æ—¶è§¦å‘å¤šç©ºä¿¡å·ï¼Œç»“åˆ ATR è®¾ç½®æ­¢ç›ˆæ­¢æŸä¸ç§»åŠ¨æ­¢æŸã€‚
//@description 
//@description ğŸ” ç‰ˆæœ¬æ›´æ–°æ—¥å¿—ï¼š
//@description 
//@description v2 (2025-08-13)ï¼š
//@description   â€¢ ã€æ ¸å¿ƒä¼˜åŒ–ã€‘å°† new_session åˆ¤æ–­ä» request.security æ”¹ä¸º time(tf_vwap)
//@description     - é˜²æ­¢é‡ç»˜ï¼šæ—§æ–¹æ³•åœ¨è·¨å‘¨æœŸè¯·æ±‚ time æ—¶å¯èƒ½å¯¼è‡´å†å²ä¿¡å·è·³å˜
//@description     - æ›´ç¨³å®šï¼šé¿å… security è°ƒç”¨å¸¦æ¥çš„å¼‚æ­¥/å»¶è¿Ÿ/æ˜ å°„é—®é¢˜
//@description     - æ›´é«˜æ•ˆï¼šæ— éœ€è·¨å“ç§è¯·æ±‚ï¼Œé™ä½èµ„æºæ¶ˆè€—
//@description     - æ¨èåšæ³•ï¼šç¬¦åˆ Pine Script v5 å¤šæ—¶é—´æ¡†æ¶æœ€ä½³å®è·µ
//@description   â€¢ ç‰¹åˆ«é€‚ç”¨äºå®ç›˜äº¤æ˜“ä¸å›æµ‹ä¸€è‡´æ€§è¦æ±‚é«˜çš„åœºæ™¯
//@description 
//@description ğŸ›  ç­–ç•¥ç‰¹æ€§ï¼š
//@description   â€¢ æ”¯æŒè‡ªå®šä¹‰é«˜çº§åˆ« VWAP å‘¨æœŸï¼ˆé»˜è®¤ï¼šå‘¨çº¿ï¼‰
//@description   â€¢ æ”¯æŒå¤šå•ä¸ç©ºå•å¼€å…³æ§åˆ¶
//@description   â€¢ åŸºäº ATR çš„æ­¢ç›ˆã€æ­¢æŸä¸ç§»åŠ¨æ­¢æŸæœºåˆ¶
//@description   â€¢ å¯è§†åŒ– VWAP çº¿ã€ä¿¡å·æ ‡è®°ä¸ K çº¿ç€è‰²
//@description 
//@description ğŸ“Š ä½¿ç”¨å»ºè®®ï¼š
//@description   â€¢ æ¨èæ—¶é—´å‘¨æœŸï¼š4å°æ—¶åŠä»¥ä¸Š
//@description   â€¢ é€‚ç”¨å¸‚åœºï¼šé«˜æ³¢åŠ¨èµ„äº§ï¼ˆå¦‚ TLSAã€Meme å¸ç­‰ï¼‰
//@description   â€¢ é£é™©æç¤ºï¼šATR å€æ•°è®¾ç½®è¿‡é«˜æˆ–è¿‡ä½å¯èƒ½å½±å“ç›ˆäºæ¯”ï¼Œè¯·æ ¹æ®å“ç§æ³¢åŠ¨æ€§è°ƒæ•´
//@description 
//@description ğŸ’¬ è”ç³»æ–¹å¼ï¼š6772228275@qq.com
//@link https://github.com/leyen-me/VWAP


strategy("vwap-v2",
     overlay = true,
     initial_capital = 10000,
     default_qty_type = strategy.percent_of_equity,
     default_qty_value = 100,
     commission_type = strategy.commission.percent,
     commission_value = 0.1)


// =======================
// è¾“å…¥å‚æ•°
// =======================

// é«˜çº§åˆ« VWAP è®¡ç®—å‘¨æœŸ
tf_vwap = input.timeframe("W", "VWAP é«˜çº§åˆ«å‘¨æœŸ")

// äº¤æ˜“æ–¹å‘å¼€å…³
allow_long  = input.bool(true,  "å…è®¸å¤šå•")
allow_short = input.bool(true,  "å…è®¸ç©ºå•")

// æ­¢ç›ˆæ­¢æŸï¼ˆåŸºäº ATRï¼‰
tp_mult   = input.float(6, "æ­¢ç›ˆå€æ•° (ATR)", minval=0.1)
sl_mult   = input.float(6, "æ­¢æŸå€æ•° (ATR)", minval=0.1)
trail_mult = input.float(5, "ç§»åŠ¨æ­¢æŸå€æ•° (ATR)", minval=0.1)
atr_len   = input.int(14, "ATR é•¿åº¦")

// å›¾å½¢é€‰é¡¹
show_vwap      = input.bool(true,  "æ˜¾ç¤º VWAP")
show_prev_vwap = input.bool(false, "æ˜¾ç¤ºä¸Šå‘¨æœŸ VWAP")
show_bars      = input.bool(true,  "æ˜¾ç¤º K çº¿é¢œè‰²")


// =======================
// å¤šæ—¶é—´æ¡†æ¶ VWAP è®¡ç®—
// =======================

// è®°å½•é«˜çº§åˆ«å‘¨æœŸçš„èµ·ç‚¹æ—¶é—´
new_session = ta.change(time(tf_vwap)) != 0

// ç´¯ç§¯è®¡ç®— VWAP
var float sum_pv   = na  // price * volume ç´¯ç§¯
var float sum_vol  = na  // volume ç´¯ç§¯
var float sum_p2v  = na  // price^2 * volume ç´¯ç§¯ï¼ˆå¯æ‰©å±•ï¼‰

if new_session
    sum_pv  := hl2 * volume
    sum_vol := volume
    sum_p2v := hl2 * hl2 * volume
else
    sum_pv  += hl2 * volume
    sum_vol += volume
    sum_p2v += hl2 * hl2 * volume

// å½“å‰ VWAP
vwap = sum_vol > 0 ? sum_pv / sum_vol : na

// ä¸Šå‘¨æœŸ VWAPï¼ˆä»…åœ¨æ–°å‘¨æœŸè®°å½•ï¼‰
var float prev_vwap = na
if new_session
    prev_vwap := vwap[1]


// =======================
// äº¤æ˜“ä¿¡å· & æ­¢ç›ˆæ­¢æŸè®¡ç®—
// =======================

// ATR è®¡ç®—
atr_val = ta.atr(atr_len)

// ä¿¡å·æ¡ä»¶
long_signal  = ta.crossover(close, vwap)   and not new_session
short_signal = ta.crossunder(close, vwap)  and not new_session

// å¤šå•æ­¢ç›ˆæ­¢æŸ
tp_long = vwap + tp_mult * atr_val
sl_long = vwap - sl_mult * atr_val

// ç©ºå•æ­¢ç›ˆæ­¢æŸ
tp_short = vwap - tp_mult * atr_val
sl_short = vwap + sl_mult * atr_val


// =======================
// äº¤æ˜“æ‰§è¡Œ
// =======================

if allow_long and long_signal
    if strategy.position_size <= 0
        if strategy.position_size < 0
            strategy.close('Short')
        strategy.entry('Long', strategy.long)

if allow_short and short_signal
    if strategy.position_size >= 0
        if strategy.position_size > 0
            strategy.close('Long')
        strategy.entry('Short', strategy.short)

strategy.exit("Exit Long", from_entry = "Long",limit = tp_long, stop = sl_long, trail_points = trail_mult * atr_val, trail_offset = trail_mult * atr_val)
strategy.exit("Exit Short", from_entry = "Short", limit = tp_short, stop = sl_short, trail_points = trail_mult * atr_val, trail_offset = trail_mult * atr_val)


// =======================
// ç»˜å›¾
// =======================
col_vwap = close > vwap ? color.green : color.red

plot(show_vwap      ? vwap      : na, "VWAP",           color = col_vwap, linewidth = 2, style = plot.style_circles)
plot(show_prev_vwap ? prev_vwap : na, "ä¸Šå‘¨æœŸ VWAP",    color = color.orange, style = plot.style_circles)
barcolor(show_bars ? col_vwap : na)

plotshape(long_signal, title = 'å¤šå•ä¿¡å·', location = location.belowbar, color = color.green, style = shape.triangleup, size = size.small)
plotshape(short_signal, title = 'ç©ºå•ä¿¡å·', location = location.abovebar, color = color.red, style = shape.triangledown, size = size.small)